{% extends "base.html" %}

{% block content %}

<!-- 프록시 목록 탭 -->
<div id="proxy-list" class="tab-panel is-active">
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h3 class="title is-4">프록시 서버 관리</h3>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-link" onclick="openModal('proxy')">
                        프록시 추가
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container mt-4">
            <table class="table is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>호스트</th>
                        <th>포트</th>
                        <th>그룹</th>
                        <th>상태</th>
                        <th>설명</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="proxyTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 리소스 설정 탭 -->
<div id="resource-config" class="tab-panel" style="display: none;">
    <div class="box">
        <h3 class="title is-4">리소스 설정</h3>

        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <div class="box" style="padding: 0.75rem 1rem;">
                        <div class="field is-horizontal" style="margin-bottom: 0;">
                            <div class="field-label is-normal" style="min-width: 9rem;">
                                <label class="label" style="margin-bottom: 0;">Community String</label>
                            </div>
                            <div class="field-body">
                                <div class="field" style="margin-bottom: 0;">
                                    <div class="control">
                                        <input class="input" id="cfgCommunity" type="text" placeholder="public" value="public">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <button class="button is-link" onclick="saveResourceConfig()">저장</button>
                        <span id="cfgStatus" class="tag is-light ml-2">로딩 중...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="columns is-multiline">
            <div class="column is-12">
                <div class="accordion is-open">
                    <div class="accordion-header"><h4>OID 설정</h4></div>
                    <div class="accordion-body">
                        <div class="columns is-multiline">
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">cpu OID</label>
                                    <input class="input is-small" id="cfgOidCpu" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">mem OID</label>
                                    <input class="input is-small" id="cfgOidMem" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">cc OID</label>
                                    <input class="input is-small" id="cfgOidCc" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">cs OID</label>
                                    <input class="input is-small" id="cfgOidCs" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">http OID (누적)</label>
                                    <input class="input is-small" id="cfgOidHttp" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">https OID (누적)</label>
                                    <input class="input is-small" id="cfgOidHttps" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                            <div class="column is-4">
                                <div class="field">
                                    <label class="label is-small">ftp OID (누적)</label>
                                    <input class="input is-small" id="cfgOidFtp" placeholder="1.3.6.1.x">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 세션브라우저 설정 탭 -->
<div id="session-config" class="tab-panel" style="display: none;">
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h3 class="title is-4">세션브라우저 설정</h3>
                </div>
            </div>
        </div>

        <div class="columns is-multiline">
            <div class="column is-3">
                <div class="field">
                    <label class="label">SSH 포트</label>
                    <div class="control">
                        <input class="input" id="sbCfgPort" type="number" min="1" max="65535" value="22">
                    </div>
                </div>
            </div>
            
            <div class="column is-3">
                <div class="field">
                    <label class="label">타임아웃(초)</label>
                    <div class="control">
                        <input class="input" id="sbCfgTimeout" type="number" min="1" max="120" value="10">
                    </div>
                </div>
            </div>
            <div class="column is-4">
                <div class="field">
                    <label class="label">호스트키 정책</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="sbCfgHostKeyPolicy">
                                <option value="auto_add">auto_add</option>
                                <option value="reject">reject</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="level">
            <div class="level-left"></div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <button class="button is-link" onclick="saveSessionConfig()">저장</button>
                        <span id="sbCfgStatus" class="tag is-light ml-2">로딩 중...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 프록시 그룹 탭 -->
<div id="proxy-groups" class="tab-panel" style="display: none;">
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h3 class="title is-4">프록시 그룹 관리</h3>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-link" onclick="openModal('group')">
                        그룹 추가
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container mt-4">
            <table class="table is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>그룹명</th>
                        <th>설명</th>
                        <th>프록시 수</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="groupTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 프록시 추가/수정 모달 -->
<div class="modal" id="proxyModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="border-radius: var(--radius-lg);">
        <header class="modal-card-head">
            <p class="modal-card-title">프록시 서버</p>
            <button class="delete" aria-label="close" onclick="closeModal('proxy')"></button>
        </header>
        <section class="modal-card-body">
            <form id="proxyForm" onsubmit="return false;">
                <input type="hidden" id="proxyId">
                <div class="field">
                    <label class="label">호스트</label>
                    <div class="control">
                        <input class="input" type="text" id="host" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">포트</label>
                    <div class="control">
                        <input class="input" type="number" id="port" min="1" max="65535" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">사용자명</label>
                    <div class="control">
                        <input class="input" type="text" id="username" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">비밀번호</label>
                    <div class="control">
                        <input class="input" type="password" id="password" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">그룹</label>
                    <div class="control">
                        <div class="select">
                            <select id="group_id">
                                <option value="">그룹 선택</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">설명 (선택)</label>
                    <div class="control">
                        <textarea class="textarea" id="description"></textarea>
                    </div>
                </div>
                <div class="field">
                    <label class="checkbox">
                        <input type="checkbox" id="is_active" checked>
                        활성화
                    </label>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-link" onclick="saveProxy()">저장</button>
            <button class="button" onclick="closeModal('proxy')">취소</button>
        </footer>
    </div>
</div>

<!-- 그룹 추가/수정 모달 -->
<div class="modal" id="groupModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="border-radius: var(--radius-lg);">
        <header class="modal-card-head">
            <p class="modal-card-title">프록시 그룹</p>
            <button class="delete" aria-label="close" onclick="closeModal('group')"></button>
        </header>
        <section class="modal-card-body">
            <form id="groupForm" onsubmit="return false;">
                <input type="hidden" id="groupId">
                <div class="field">
                    <label class="label">그룹명</label>
                    <div class="control">
                        <input class="input" type="text" id="groupName" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">설명</label>
                    <div class="control">
                        <textarea class="textarea" id="groupDescription"></textarea>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-link" onclick="saveGroup()">저장</button>
            <button class="button" onclick="closeModal('group')">취소</button>
        </footer>
    </div>
</div>

<script>
// 공통 유틸리티 함수
const utils = {
    showError: (message) => alert(message || '오류가 발생했습니다.'),
    formatTag: (isActive) => isActive ? 
        '<span class="tag is-success">활성</span>' : 
        '<span class="tag is-danger">비활성</span>',
    resetForm: (formId) => document.getElementById(formId).reset()
};

// 탭 관리
function activateSettingsTab(targetId) {
    document.querySelectorAll('.tabs li').forEach(t => {
        if (t.dataset && t.dataset.target) {
            t.classList.toggle('is-active', t.dataset.target === targetId);
        }
    });
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.style.display = 'none';
    });
    const targetEl = document.getElementById(targetId);
    if (targetEl) targetEl.style.display = 'block';
}

// Clicks on navbar submenu are normal links to '/#<id>' so when we land here, sync by hash
function initSettingsTabsFromHash() {
    const hash = (window.location.hash || '#proxy-list').replace('#', '');
    activateSettingsTab(hash);
}

document.addEventListener('DOMContentLoaded', function() {
    initSettingsTabsFromHash();
    window.addEventListener('hashchange', initSettingsTabsFromHash);
});

// 모달 관리
function openModal(type, id = null) {
    const modalId = `${type}Modal`;
    if (id) {
        const endpoint = type === 'proxy' ? 'proxies' : 'proxy-groups';
        $.get(`/api/${endpoint}/${id}`)
            .done(data => fillForm(type, data))
            .fail(() => utils.showError('데이터를 불러오는데 실패했습니다.'));
    } else {
        utils.resetForm(`${type}Form`);
        $(`#${type}Id`).val('');
    }
    $(`#${modalId}`).addClass('is-active');
}

function closeModal(type) {
    $(`#${type}Modal`).removeClass('is-active');
}

function fillForm(type, data) {
    if (type === 'proxy') {
        $('#proxyId').val(data.id);
        $('#host').val(data.host);
        $('#port').val(data.port);
        $('#username').val(data.username);
        $('#password').val('');
        $('#group_id').val(data.group_id || '');
        $('#description').val(data.description || '');
        $('#is_active').prop('checked', data.is_active);
    } else {
        $('#groupId').val(data.id);
        $('#groupName').val(data.name);
        $('#groupDescription').val(data.description || '');
    }
}

// 프록시 관리
function loadProxies() {
    $.get('/api/proxies')
        .done(proxies => {
            const tbody = $('#proxyTableBody');
            tbody.empty();
            
            proxies.forEach(proxy => {
                tbody.append(`
                    <tr>
                        <td>${proxy.host}</td>
                        <td>${proxy.port}</td>
                        <td>${proxy.group_name || '-'}</td>
                        <td>${utils.formatTag(proxy.is_active)}</td>
                        <td>${proxy.description || ''}</td>
                        <td>
                            <div class="buttons are-small">
                                <button class="button is-link is-light" onclick="openModal('proxy', ${proxy.id})">
                                    수정
                                </button>
                                <button class="button is-danger is-light" onclick="deleteProxy(${proxy.id})">
                                    삭제
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        })
        .fail(() => utils.showError('프록시 목록을 불러오는데 실패했습니다.'));

    // 그룹 선택 옵션 업데이트
    $.get('/api/proxy-groups')
        .done(groups => {
            const select = $('#group_id');
            select.find('option:gt(0)').remove();
            groups.forEach(group => {
                select.append(`<option value="${group.id}">${group.name}</option>`);
            });
        });
}

function saveProxy() {
    const proxyId = $('#proxyId').val();
    const password = $('#password').val();
    
    const data = {
        host: $('#host').val(),
        port: parseInt($('#port').val()),
        username: $('#username').val(),
        is_active: $('#is_active').is(':checked'),
        group_id: $('#group_id').val() ? parseInt($('#group_id').val()) : null,
        description: $('#description').val() || null
    };

    if (!proxyId || password) {
        data.password = password;
    }

    const method = proxyId ? 'PUT' : 'POST';
    const url = proxyId ? `/api/proxies/${proxyId}` : '/api/proxies';

    $.ajax({
        url,
        method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: () => {
            loadProxies();
            closeModal('proxy');
        },
        error: (xhr) => utils.showError(xhr.responseText)
    });
}

function deleteProxy(id) {
    if (confirm('정말 삭제하시겠습니까?')) {
        $.ajax({
            url: `/api/proxies/${id}`,
            method: 'DELETE',
            success: loadProxies,
            error: (xhr) => utils.showError(xhr.responseText)
        });
    }
}

// 테스트 기능 제거됨

// 그룹 관리
function loadGroups() {
    $.get('/api/proxy-groups')
        .done(groups => {
            console.log('Loaded groups:', groups);  // 디버깅용
            const tbody = $('#groupTableBody');
            tbody.empty();
            
            groups.forEach(group => {
                tbody.append(`
                    <tr>
                        <td>${group.name}</td>
                        <td>${group.description || ''}</td>
                        <td>${group.proxies_count}</td>
                        <td>
                            <div class="buttons are-small">
                                <button class="button is-link is-light" onclick="openModal('group', ${group.id})">
                                    수정
                                </button>
                                <button class="button is-danger is-light" onclick="deleteGroup(${group.id})">
                                    삭제
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        })
        .fail((xhr) => {
            console.error('Failed to load groups:', xhr);  // 디버깅용
            utils.showError('그룹 목록을 불러오는데 실패했습니다.');
        });
}

// SNMP 설정 로드/저장
function loadResourceConfig() {
    $.get('/api/resource-config')
        .done(cfg => {
            $('#cfgCommunity').val(cfg.community || 'public');
            const oids = cfg.oids || {};
            $('#cfgOidCpu').val(oids.cpu || '');
            $('#cfgOidMem').val(oids.mem || '');
            $('#cfgOidCc').val(oids.cc || '');
            $('#cfgOidCs').val(oids.cs || '');
            $('#cfgOidHttp').val(oids.http || '');
            $('#cfgOidHttps').val(oids.https || '');
            $('#cfgOidFtp').val(oids.ftp || '');
            $('#cfgStatus').removeClass('is-danger').addClass('is-success').text('불러오기 완료');
        })
        .fail(() => {
            $('#cfgStatus').removeClass('is-success').addClass('is-danger').text('불러오기 실패');
        });
}

function saveResourceConfig() {
    const payload = {
        community: ($('#cfgCommunity').val() || 'public').toString(),
        oids: {
            cpu: $('#cfgOidCpu').val() || undefined,
            mem: $('#cfgOidMem').val() || undefined,
            cc: $('#cfgOidCc').val() || undefined,
            cs: $('#cfgOidCs').val() || undefined,
            http: $('#cfgOidHttp').val() || undefined,
            https: $('#cfgOidHttps').val() || undefined,
            ftp: $('#cfgOidFtp').val() || undefined,
        }
    };
    // remove undefined keys
    Object.keys(payload.oids).forEach(k => { if (!payload.oids[k]) delete payload.oids[k]; });

    $.ajax({
        url: '/api/resource-config',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: () => {
            $('#cfgStatus').removeClass('is-danger').addClass('is-success').text('저장 완료');
        },
        error: () => {
            $('#cfgStatus').removeClass('is-success').addClass('is-danger').text('저장 실패');
        }
    });
}

// 세션브라우저 설정 로드/저장
function loadSessionConfig() {
    $.get('/api/session-browser/config')
        .done(cfg => {
            $('#sbCfgPort').val(cfg.ssh_port || 22);
            $('#sbCfgTimeout').val(cfg.timeout_sec || 10);
            $('#sbCfgHostKeyPolicy').val(cfg.host_key_policy || 'auto_add');
            $('#sbCfgStatus').removeClass('is-danger').addClass('is-success').text('불러오기 완료');
        })
        .fail(() => {
            $('#sbCfgStatus').removeClass('is-success').addClass('is-danger').text('불러오기 실패');
        });
}

function saveSessionConfig() {
    const payload = {
        ssh_port: parseInt($('#sbCfgPort').val(), 10) || 22,
        timeout_sec: parseInt($('#sbCfgTimeout').val(), 10) || 10,
        host_key_policy: ($('#sbCfgHostKeyPolicy').val() || 'auto_add').toString()
    };

    $.ajax({
        url: '/api/session-browser/config',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: () => {
            $('#sbCfgStatus').removeClass('is-danger').addClass('is-success').text('저장 완료');
        },
        error: () => {
            $('#sbCfgStatus').removeClass('is-success').addClass('is-danger').text('저장 실패');
        }
    });
}

function saveGroup() {
    const groupId = $('#groupId').val();
    const data = {
        name: $('#groupName').val(),
        description: $('#groupDescription').val() || null
    };

    const method = groupId ? 'PUT' : 'POST';
    const url = groupId ? `/api/proxy-groups/${groupId}` : '/api/proxy-groups';

    $.ajax({
        url,
        method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: () => {
            loadGroups();
            loadProxies();
            closeModal('group');
        },
        error: (xhr) => utils.showError(xhr.responseText)
    });
}

function deleteGroup(id) {
    if (confirm('정말 삭제하시겠습니까?\n그룹에 속한 프록시들은 기본 그룹으로 이동됩니다.')) {
        $.ajax({
            url: `/api/proxy-groups/${id}`,
            method: 'DELETE',
            success: () => {
                loadGroups();
                loadProxies();
            },
            error: (xhr) => utils.showError(xhr.responseText)
        });
    }
}

// 초기화
$(document).ready(() => {
    loadProxies();
    loadGroups();
    loadResourceConfig();
    loadSessionConfig();
});
</script>
{% endblock %}