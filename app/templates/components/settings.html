{% extends "base.html" %}

{% block content %}
<div class="tabs">
    <ul>
        <li class="is-active" data-target="proxy-list"><a>프록시 목록</a></li>
        <li data-target="proxy-groups"><a>프록시 그룹</a></li>
    </ul>
</div>

<!-- 프록시 목록 탭 -->
<div id="proxy-list" class="tab-panel is-active">
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h3 class="title is-4">프록시 서버 관리</h3>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-link" onclick="openAddProxyModal()">
                        프록시 추가
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container mt-4">
            <table class="table is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>호스트</th>
                        <th>포트</th>
                        <th>그룹</th>
                        <th>상태</th>
                        <th>설명</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="proxyTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 프록시 그룹 탭 -->
<div id="proxy-groups" class="tab-panel" style="display: none;">
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h3 class="title is-4">프록시 그룹 관리</h3>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-link" onclick="openAddGroupModal()">
                        그룹 추가
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container mt-4">
            <table class="table is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>그룹명</th>
                        <th>설명</th>
                        <th>프록시 수</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="groupTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 프록시 추가/수정 모달 -->
<div class="modal" id="proxyModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">프록시 서버</p>
            <button class="delete" aria-label="close" onclick="closeProxyModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="proxyForm">
                <input type="hidden" id="proxyId">
                <div class="field">
                    <label class="label">호스트</label>
                    <div class="control">
                        <input class="input" type="text" id="host" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">포트</label>
                    <div class="control">
                        <input class="input" type="number" id="port" min="1" max="65535" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">사용자명</label>
                    <div class="control">
                        <input class="input" type="text" id="username" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">비밀번호</label>
                    <div class="control">
                        <input class="input" type="password" id="password" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">그룹</label>
                    <div class="control">
                        <div class="select">
                            <select id="group_id">
                                <option value="">그룹 선택</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">설명 (선택)</label>
                    <div class="control">
                        <textarea class="textarea" id="description"></textarea>
                    </div>
                </div>
                <div class="field">
                    <label class="checkbox">
                        <input type="checkbox" id="is_active" checked>
                        활성화
                    </label>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-link" onclick="saveProxy()">저장</button>
            <button class="button" onclick="closeProxyModal()">취소</button>
        </footer>
    </div>
</div>

<!-- 그룹 추가/수정 모달 -->
<div class="modal" id="groupModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">프록시 그룹</p>
            <button class="delete" aria-label="close" onclick="closeGroupModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="groupForm">
                <input type="hidden" id="groupId">
                <div class="field">
                    <label class="label">그룹명</label>
                    <div class="control">
                        <input class="input" type="text" id="groupName" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">설명</label>
                    <div class="control">
                        <textarea class="textarea" id="groupDescription"></textarea>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-link" onclick="saveGroup()">저장</button>
            <button class="button" onclick="closeGroupModal()">취소</button>
        </footer>
    </div>
</div>

<script>
// 탭 전환 처리
document.querySelectorAll('.tabs li').forEach(tab => {
    tab.addEventListener('click', () => {
        // 활성 탭 변경
        document.querySelectorAll('.tabs li').forEach(t => t.classList.remove('is-active'));
        tab.classList.add('is-active');
        
        // 패널 전환
        const target = tab.dataset.target;
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.display = 'none';
        });
        document.getElementById(target).style.display = 'block';
    });
});

// 프록시 관련 함수들
function loadProxies() {
    // 프록시 목록 로드
    $.get('/api/proxies', function(proxies) {
        const tbody = $('#proxyTableBody');
        tbody.empty();
        
        proxies.forEach(proxy => {
            tbody.append(`
                <tr>
                    <td>${proxy.host}</td>
                    <td>${proxy.port}</td>
                    <td>${proxy.group?.name || '-'}</td>
                    <td>
                        ${proxy.is_active ? 
                            '<span class="tag is-success">활성</span>' : 
                            '<span class="tag is-danger">비활성</span>'}
                    </td>
                    <td>${proxy.description || ''}</td>
                    <td>
                        <div class="buttons are-small">
                            <button class="button is-link is-light" onclick="editProxy(${proxy.id})">
                                수정
                            </button>
                            <button class="button is-danger is-light" onclick="deleteProxy(${proxy.id})">
                                삭제
                            </button>
                            <button class="button is-success is-light" onclick="testProxy(${proxy.id})">
                                테스트
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });
    });

    // 그룹 선택 옵션 업데이트
    $.get('/api/proxy-groups', function(groups) {
        const select = $('#group_id');
        select.find('option:gt(0)').remove(); // 첫 번째 옵션('그룹 선택')을 제외한 모든 옵션 제거
        
        groups.forEach(group => {
            select.append(`<option value="${group.id}">${group.name}</option>`);
        });
    });
}

// 그룹 관련 함수들
function loadGroups() {
    $.get('/api/proxy-groups', function(groups) {
        const tbody = $('#groupTableBody');
        tbody.empty();
        
        groups.forEach(group => {
            tbody.append(`
                <tr>
                    <td>${group.name}</td>
                    <td>${group.description || ''}</td>
                    <td>${group.proxies.length}</td>
                    <td>
                        <div class="buttons are-small">
                            <button class="button is-link is-light" onclick="editGroup(${group.id})">
                                수정
                            </button>
                            <button class="button is-danger is-light" onclick="deleteGroup(${group.id})">
                                삭제
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });
    });
}

function openAddGroupModal() {
    $('#groupForm')[0].reset();
    $('#groupId').val('');
    $('#groupModal').addClass('is-active');
}

function closeGroupModal() {
    $('#groupModal').removeClass('is-active');
}

function saveGroup() {
    const groupId = $('#groupId').val();
    const data = {
        name: $('#groupName').val(),
        description: $('#groupDescription').val() || null
    };

    const method = groupId ? 'PUT' : 'POST';
    const url = groupId ? `/api/proxy-groups/${groupId}` : '/api/proxy-groups';

    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            loadGroups();
            loadProxies(); // 프록시 목록의 그룹 정보도 업데이트
            closeGroupModal();
        },
        error: function(xhr) {
            alert('오류가 발생했습니다: ' + xhr.responseText);
        }
    });
}

function editGroup(id) {
    $.get(`/api/proxy-groups/${id}`, function(group) {
        $('#groupId').val(group.id);
        $('#groupName').val(group.name);
        $('#groupDescription').val(group.description);
        $('#groupModal').addClass('is-active');
    });
}

function deleteGroup(id) {
    if (confirm('정말 삭제하시겠습니까?\n그룹에 속한 프록시들은 기본 그룹으로 이동됩니다.')) {
        $.ajax({
            url: `/api/proxy-groups/${id}`,
            method: 'DELETE',
            success: function() {
                loadGroups();
                loadProxies(); // 프록시 목록도 업데이트
            },
            error: function(xhr) {
                alert('오류가 발생했습니다: ' + xhr.responseText);
            }
        });
    }
}

// 페이지 로드 시 초기화
$(document).ready(function() {
    loadProxies();
    loadGroups();
});

// 기존 프록시 관련 함수들...
function openAddProxyModal() {
    $('#proxyForm')[0].reset();
    $('#proxyId').val('');
    $('#proxyModal').addClass('is-active');
}

function closeProxyModal() {
    $('#proxyModal').removeClass('is-active');
}

function saveProxy() {
    const proxyId = $('#proxyId').val();
    const password = $('#password').val();
    
    // 기본 데이터 구성
    const data = {
        host: $('#host').val(),
        port: parseInt($('#port').val()),
        username: $('#username').val(),
        is_active: $('#is_active').is(':checked'),
        group_id: $('#group_id').val() ? parseInt($('#group_id').val()) : null,
        description: $('#description').val() || null
    };

    // 수정 시 비밀번호가 입력된 경우에만 포함
    if (proxyId && !password) {
        console.log('Updating without password');  // 디버깅용
    } else {
        data.password = password;
    }

    const method = proxyId ? 'PUT' : 'POST';
    const url = proxyId ? `/api/proxies/${proxyId}` : '/api/proxies';

    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            loadProxies();
            closeProxyModal();
        },
        error: function(xhr) {
            alert('오류가 발생했습니다: ' + xhr.responseText);
        }
    });
}

function editProxy(id) {
    console.log('Editing proxy with ID:', id);  // 디버깅용
    
    // 먼저 모달을 초기화
    $('#proxyForm')[0].reset();
    $('#proxyId').val(id);
    
    // 프록시 정보 가져오기
    $.get(`/api/proxies/${id}`)
        .done(function(proxy) {
            console.log('Received proxy data:', proxy);  // 디버깅용
            
            // 폼 필드 채우기
            $('#host').val(proxy.host || '');
            $('#port').val(proxy.port || '');
            $('#username').val(proxy.username || '');
            $('#password').val('');  // 수정 시에는 비밀번호를 입력하지 않으면 기존 값 유지
            $('#group_id').val(proxy.group_id || '');
            $('#description').val(proxy.description || '');
            $('#is_active').prop('checked', proxy.is_active);
            
            // 모달 표시
            $('#proxyModal').addClass('is-active');
        })
        .fail(function(xhr) {
            console.error('Failed to get proxy:', xhr);  // 디버깅용
            alert('프록시 정보를 불러오는데 실패했습니다.');
        });
}

function deleteProxy(id) {
    if (confirm('정말 삭제하시겠습니까?')) {
        $.ajax({
            url: `/api/proxies/${id}`,
            method: 'DELETE',
            success: function() {
                loadProxies();
            },
            error: function(xhr) {
                alert('오류가 발생했습니다: ' + xhr.responseText);
            }
        });
    }
}

function testProxy(id) {
    $.post(`/api/proxies/${id}/test`, function(result) {
        alert('테스트 성공: ' + result.message);
    }).fail(function(xhr) {
        alert('테스트 실패: ' + xhr.responseJSON.detail);
    });
}
</script>
{% endblock %}