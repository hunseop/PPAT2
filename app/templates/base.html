<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PPAT</title>
    <link rel="stylesheet" href="/static/vendor/bulma/bulma.min.css">
    <script src="/static/vendor/jquery/jquery-3.7.1.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.is-active {
            display: block;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar is-link mb-3" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold" href="/">
                    PPAT
                </a>
            </div>

            <div class="navbar-menu">
                <div class="navbar-end">
                    <a class="navbar-item tab-link" data-tab="resource">
                        자원사용률
                    </a>
                    <a class="navbar-item tab-link" data-tab="sessions">
                        세션브라우저
                    </a>
                    <a class="navbar-item tab-link is-active" data-tab="settings">
                        설정
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <div id="resource" class="tab-content">
                <div class="box">
                    <h3 class="title is-4">자원사용률 모니터링</h3>

                    <div class="columns is-multiline">
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">그룹</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="ruGroupSelect">
                                            <option value="">전체</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-8">
                            <div class="field">
                                <label class="label">프록시 선택</label>
                                <div class="control">
                                    <div class="columns is-gapless">
                                        <div class="column is-narrow">
                                            <label class="checkbox mr-3">
                                                <input type="checkbox" id="ruSelectAll"> 모두 선택
                                            </label>
                                        </div>
                                        <div class="column">
                                            <div class="select is-multiple is-fullwidth">
                                                <select id="ruProxySelect" multiple size="6"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="column is-3">
                            <div class="field">
                                <label class="label">SNMP Community</label>
                                <div class="control">
                                    <input class="input" id="ruCommunity" type="text" placeholder="public" value="public">
                                </div>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label class="label">주기(초)</label>
                                <div class="control has-icons-right">
                                    <input class="input" id="ruIntervalSec" type="number" min="5" step="1" value="30">
                                    <span class="icon is-small is-right">s</span>
                                </div>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label class="label">OID 매핑 (비어있으면 해당 항목은 수집 안 함)</label>
                            </div>
                            <div class="columns is-multiline">
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">cpu</label>
                                        <input class="input is-small" id="oidCpu" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">mem</label>
                                        <input class="input is-small" id="oidMem" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">cc</label>
                                        <input class="input is-small" id="oidCc" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">cs</label>
                                        <input class="input is-small" id="oidCs" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">http (누적)</label>
                                        <input class="input is-small" id="oidHttp" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">https (누적)</label>
                                        <input class="input is-small" id="oidHttps" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                                <div class="column is-4">
                                    <div class="field">
                                        <label class="label is-small">ftp (누적)</label>
                                        <input class="input is-small" id="oidFtp" placeholder="예: 1.3.6.1.x">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="column is-12">
                            <div class="buttons">
                                <button class="button is-success" id="ruStartBtn">시작</button>
                                <button class="button is-danger" id="ruStopBtn" disabled>중지</button>
                                <span id="ruStatus" class="tag is-light ml-2">정지됨</span>
                            </div>
                            <p id="ruError" class="help is-danger" style="display:none;"></p>
                        </div>
                    </div>

                    <div class="table-container mt-4">
                        <table class="table is-fullwidth is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>프록시</th>
                                    <th>수집시각</th>
                                    <th>CPU</th>
                                    <th>MEM</th>
                                    <th>CC</th>
                                    <th>CS</th>
                                    <th>HTTP Δ</th>
                                    <th>HTTPS Δ</th>
                                    <th>FTP Δ</th>
                                </tr>
                            </thead>
                            <tbody id="ruTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="sessions" class="tab-content">
                <div class="notification is-info">
                    세션브라우저 기능은 준비 중입니다.
                </div>
            </div>
            <div id="settings" class="tab-content is-active">
                {% block content %}{% endblock %}
            </div>
        </div>
    </section>

    <script>
        $(document).ready(function() {
            // ----------------- Resource Usage Page Logic -----------------
            const ru = {
                intervalId: null,
                lastCumulativeByProxy: {}, // proxyId -> { http, https, ftp }
                proxies: [],
                groups: [],
            };

            function showRuError(msg) {
                $('#ruError').text(msg).show();
            }
            function clearRuError() {
                $('#ruError').hide().text('');
            }

            function setRunning(running) {
                if (running) {
                    $('#ruStartBtn').attr('disabled', true);
                    $('#ruStopBtn').attr('disabled', false);
                    $('#ruStatus').removeClass('is-light').removeClass('is-danger').addClass('is-success').text('실행 중');
                } else {
                    $('#ruStartBtn').attr('disabled', false);
                    $('#ruStopBtn').attr('disabled', true);
                    $('#ruStatus').removeClass('is-success').removeClass('is-danger').addClass('is-light').text('정지됨');
                }
            }

            function fetchGroups() {
                return $.getJSON('/api/proxy-groups').then(data => {
                    ru.groups = data || [];
                    const $sel = $('#ruGroupSelect');
                    $sel.empty();
                    $sel.append('<option value="">전체</option>');
                    ru.groups.forEach(g => {
                        $sel.append(`<option value="${g.id}">${g.name}</option>`);
                    });
                }).catch(() => {
                    showRuError('그룹 목록을 불러오지 못했습니다.');
                });
            }

            function fetchProxies() {
                return $.getJSON('/api/proxies').then(data => {
                    ru.proxies = data || [];
                    renderProxySelect();
                }).catch(() => {
                    showRuError('프록시 목록을 불러오지 못했습니다.');
                });
            }

            function renderProxySelect() {
                const selectedGroupId = $('#ruGroupSelect').val();
                const $sel = $('#ruProxySelect');
                $sel.empty();
                (ru.proxies || []).filter(p => {
                    if (!selectedGroupId) return true;
                    return String(p.group_id || '') === String(selectedGroupId);
                }).forEach(p => {
                    const label = `${p.host}:${p.port}${p.group_name ? ' ('+p.group_name+')' : ''}`;
                    $sel.append(`<option value="${p.id}">${label}</option>`);
                });
            }

            function getSelectedProxyIds() {
                return ($('#ruProxySelect').val() || []).map(v => parseInt(v, 10));
            }

            function buildOids() {
                const map = {};
                const addIf = (key, val) => { if (val && val.trim().length > 0) map[key] = val.trim(); };
                addIf('cpu', $('#oidCpu').val());
                addIf('mem', $('#oidMem').val());
                addIf('cc', $('#oidCc').val());
                addIf('cs', $('#oidCs').val());
                addIf('http', $('#oidHttp').val());
                addIf('https', $('#oidHttps').val());
                addIf('ftp', $('#oidFtp').val());
                return map;
            }

            function updateTable(items) {
                const $tbody = $('#ruTableBody');
                items.forEach(row => {
                    const proxy = (ru.proxies || []).find(p => p.id === row.proxy_id);
                    const name = proxy ? `${proxy.host}:${proxy.port}` : `#${row.proxy_id}`;

                    const last = ru.lastCumulativeByProxy[row.proxy_id] || {};
                    const deltas = { http: null, https: null, ftp: null };
                    ['http','https','ftp'].forEach(k => {
                        const v = row[k];
                        if (typeof v === 'number' && typeof last[k] === 'number') {
                            const d = v - last[k];
                            deltas[k] = (d >= 0) ? d : null; // 누적 리셋 시 음수는 무시
                        }
                    });

                    // 현재 값을 다음 계산을 위해 저장
                    ru.lastCumulativeByProxy[row.proxy_id] = {
                        http: typeof row.http === 'number' ? row.http : last.http,
                        https: typeof row.https === 'number' ? row.https : last.https,
                        ftp: typeof row.ftp === 'number' ? row.ftp : last.ftp,
                    };

                    const trId = `ru-row-${row.proxy_id}`;
                    const cpuStr = (row.cpu ?? '').toString();
                    const memStr = (row.mem ?? '').toString();
                    const ccStr = (row.cc ?? '').toString();
                    const csStr = (row.cs ?? '').toString();
                    const httpStr = (deltas.http ?? '').toString();
                    const httpsStr = (deltas.https ?? '').toString();
                    const ftpStr = (deltas.ftp ?? '').toString();
                    const timeStr = row.collected_at ? new Date(row.collected_at).toLocaleString() : '';

                    const rowHtml = `
                        <tr id="${trId}">
                            <td>${name}</td>
                            <td>${timeStr}</td>
                            <td>${cpuStr}</td>
                            <td>${memStr}</td>
                            <td>${ccStr}</td>
                            <td>${csStr}</td>
                            <td>${httpStr}</td>
                            <td>${httpsStr}</td>
                            <td>${ftpStr}</td>
                        </tr>`;
                    const $existing = $(`#${trId}`);
                    if ($existing.length) {
                        $existing.replaceWith(rowHtml);
                    } else {
                        $tbody.append(rowHtml);
                    }
                });
            }

            function collectOnce() {
                clearRuError();
                const proxyIds = getSelectedProxyIds();
                if (proxyIds.length === 0) {
                    showRuError('프록시를 하나 이상 선택하세요.');
                    return;
                }
                const community = ($('#ruCommunity').val() || 'public').toString();
                const oids = buildOids();
                if (Object.keys(oids).length === 0) {
                    showRuError('최소 1개의 OID를 입력하세요.');
                    return;
                }
                return $.ajax({
                    url: '/api/resource-usage/collect',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ proxy_ids: proxyIds, community: community, oids: oids })
                }).then(res => {
                    if (res && res.items) {
                        updateTable(res.items);
                    }
                    if (res && res.failed && res.failed > 0) {
                        showRuError('일부 프록시 수집에 실패했습니다.');
                    }
                }).catch(err => {
                    showRuError('수집 요청 중 오류가 발생했습니다.');
                });
            }

            function startPolling() {
                if (ru.intervalId) return; // already running
                const intervalSec = parseInt($('#ruIntervalSec').val(), 10) || 30;
                const periodMs = Math.max(5, intervalSec) * 1000;
                setRunning(true);
                collectOnce();
                ru.intervalId = setInterval(() => {
                    collectOnce();
                }, periodMs);
            }

            function stopPolling() {
                if (ru.intervalId) {
                    clearInterval(ru.intervalId);
                    ru.intervalId = null;
                }
                setRunning(false);
            }

            // UI bindings
            $('#ruStartBtn').on('click', function() { startPolling(); });
            $('#ruStopBtn').on('click', function() { stopPolling(); });
            $('#ruGroupSelect').on('change', function() {
                renderProxySelect();
                // 그룹 변경 시 델타 기준 초기화 및 테이블 초기화
                ru.lastCumulativeByProxy = {};
                $('#ruTableBody').empty();
            });
            $('#ruSelectAll').on('change', function() {
                const checked = $(this).is(':checked');
                $('#ruProxySelect option').prop('selected', checked);
            });

            // 초기 데이터 로드
            Promise.all([fetchGroups(), fetchProxies()]).then(() => {
                // no-op
            });

            $('.tab-link').click(function(e) {
                e.preventDefault();
                const tabId = $(this).data('tab');
                
                // 탭 활성화 상태 변경
                $('.tab-link').removeClass('is-active');
                $(this).addClass('is-active');
                
                // 컨텐츠 표시/숨김
                $('.tab-content').removeClass('is-active');
                $(`#${tabId}`).addClass('is-active');

                // URL 해시 업데이트
                window.history.pushState(null, '', `#${tabId}`);
            });

            // 페이지 로드시 URL 해시에 따라 탭 활성화
            const hash = window.location.hash.substring(1);
            if (hash && ['resource', 'sessions', 'settings'].includes(hash)) {
                $(`.tab-link[data-tab="${hash}"]`).click();
            }
        });
    </script>
</body>
</html>
